<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Card transaction categorizing - Version 1</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            line-height: 1.6;
            background-color: #f4f7f9;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2.5rem;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        h1 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #e0e6ed;
            padding-bottom: 0.5rem;
        }
        h2 {
            color: #34495e;
            font-size: 1.5em;
            margin-top: 1.5rem;
        }
        p {
            color: #555;
            margin-bottom: 1.5rem;
        }
        .input-group {
            margin-bottom: 2.5rem;
        }
        .transaction-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid #e0e6ed;
        }
        .transaction-details {
            flex-grow: 1;
        }
        .transaction-details span {
            display: block;
            margin-bottom: 0.25rem;
        }
        .category-select {
            display: flex;
            gap: 1.5rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }
        /* Category specific colors */
        .category-select label[for*="sharrif"] { color: #8E44AD; }
        .category-select label[for*="amrita"] { color: #27AE60; }
        .category-select label[for*="shared"] { color: #F39C12; }

        .results {
            margin-top: 2rem;
            font-size: 1.25em;
            font-weight: bold;
        }
        .results div {
            padding: 0.5rem 0;
        }
        #sharrifTotal, #sharrifTotalInfo { color: #8E44AD; }
        #amritaTotal, #amritaTotalInfo { color: #27AE60; }
        #sharedTotalInfo { color: #F39C12; }

        button {
            padding: 12px 24px;
            background-color: #3498DB;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 1.5rem;
        }
        button:hover {
            background-color: #2980B9;
            transform: translateY(-2px);
        }
        input[type="file"] {
            display: none;
        }
        .upload-button {
            background-color: #2ECC71;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .upload-button:hover {
            background-color: #27AE60;
        }
        #message {
            margin-top: 1rem;
            font-weight: bold;
        }
        .info-box {
            background-color: #ecf0f1;
            border-left: 4px solid #bdc3c7;
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 4px;
        }
        .app-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .app-header h1 {
            border-bottom: none;
        }
        .app-header p {
            font-size: 0.9em;
            color: #777;
            margin-top: -1.5rem;
        }
        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }
        .title-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            margin-top: 0.5rem;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h1>Credit Card transaction categorizing</h1>
        <p>Created by Sharrif. Version 1</p>
    </div>
    
    <div class="input-group">
        <label for="reportTitle">Set a title for your report:</label>
        <input type="text" id="reportTitle" class="title-input" placeholder="e.g., Visa Sept 1, 2025 - Sept 12, 2025">
    </div>

    <p>Upload your Excel file to get started. Please ensure your file has columns for **Date**, **Vendor**, and **Amount**. If a **Category** column is included, it will be used automatically.</p>
    
    <div class="input-group">
        <label for="excelFile" class="upload-button button">Choose Excel File</label>
        <input type="file" id="excelFile" accept=".xls, .xlsx">
        <div id="message"></div>
    </div>

    <div id="categorizationSection" style="display: none;">
        <h2>Categorize Transactions</h2>
        <div class="info-box">
            <h3>Total Amount Before Categorizing</h3>
            <div id="totalAmount"></div>
        </div>
        <div id="transactionList"></div>
        <div class="action-buttons">
            <button onclick="calculateTotals()">Calculate Final Totals</button>
            <button onclick="saveHtml()">Save HTML</button>
        </div>
    </div>

    <div class="results" id="resultsSection" style="display: none;">
        <h2>Final Totals</h2>
        <div id="sharrifTotal"></div>
        <div id="amritaTotal"></div>
        <button onclick="downloadCSV()">Download Final Report (CSV)</button>
    </div>

    <div class="results info-box" id="infoSection" style="display: none;">
        <h2>For Information Purposes</h2>
        <p>This is a running total of the categories before splitting the shared transactions.</p>
        <div id="sharrifTotalInfo"></div>
        <div id="amritaTotalInfo"></div>
        <div id="sharedTotalInfo"></div>
    </div>
</div>

<script id="saved-data-script" type="application/json">
    {}
</script>

<script>
    let transactions = [];

    const savedDataElement = document.getElementById('saved-data-script');
    if (savedDataElement && savedDataElement.textContent.trim() !== '{}') {
        const savedData = JSON.parse(savedDataElement.textContent);
        if (savedData.transactions) {
            transactions = savedData.transactions;
            if (savedData.title) {
                document.getElementById('reportTitle').value = savedData.title;
            }
            renderTransactionsForCategorization();
        }
    }

    function excelDateToJSDate(excelDate) {
        if (typeof excelDate === 'number') {
            const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
            const year = date.getUTCFullYear();
            const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
            const day = date.getUTCDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        return excelDate;
    }

    document.getElementById('excelFile').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    processTransactionsFromExcel(json);
                    document.getElementById('message').innerText = `File "${file.name}" successfully loaded.`;
                    document.getElementById('message').style.color = 'green';
                } catch (error) {
                    document.getElementById('message').innerText = 'Error processing file. Please check the format.';
                    document.getElementById('message').style.color = 'red';
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
    });

    function processTransactionsFromExcel(data) {
        if (data.length < 2) {
            alert("No data found in the Excel file.");
            return;
        }

        const header = data[0].map(h => String(h).toLowerCase().trim());
        const dateIndex = header.indexOf('date');
        const vendorIndex = header.indexOf('vendor');
        const amountIndex = header.indexOf('amount');
        const categoryIndex = header.indexOf('category');

        if (dateIndex === -1 || vendorIndex === -1 || amountIndex === -1) {
            alert("Excel file must contain 'Date', 'Vendor', and 'Amount' columns.");
            return;
        }

        transactions = [];
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            const date = row[dateIndex];
            const vendor = row[vendorIndex];
            const amount = parseFloat(row[amountIndex]);
            const category = categoryIndex !== -1 ? String(row[categoryIndex]).toLowerCase().trim() : '';

            if (!isNaN(amount) && date && vendor) {
                transactions.push({ 
                    date: excelDateToJSDate(date), 
                    vendor: String(vendor), 
                    amount, 
                    category: category 
                });
            }
        }
        if (transactions.length > 0) {
            renderTransactionsForCategorization();
        } else {
            alert("No valid transactions found in the Excel file.");
        }
    }

    function renderTransactionsForCategorization() {
        const transactionList = document.getElementById('transactionList');
        transactionList.innerHTML = '';
        document.getElementById('categorizationSection').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
        
        const totalAmount = transactions.reduce((sum, t) => sum + t.amount, 0);
        document.getElementById('totalAmount').innerText = `$${totalAmount.toFixed(2)}`;
        
        calculateInfoTotals();

        transactions.forEach((t, index) => {
            const item = document.createElement('div');
            item.className = 'transaction-item';
            
            const isCheckedSharrif = t.category === 'sharrif' ? 'checked' : '';
            const isCheckedAmrita = t.category === 'amrita' ? 'checked' : '';
            const isCheckedShared = t.category === 'shared' ? 'checked' : '';

            item.innerHTML = `
                <div class="transaction-details">
                    <span><strong>Date:</strong> ${t.date}</span>
                    <span><strong>Vendor:</strong> ${t.vendor}</span>
                    <span><strong>Amount:</strong> $${t.amount.toFixed(2)}</span>
                </div>
                <div class="category-select">
                    <label for="sharrif-${index}">
                        <input type="radio" id="sharrif-${index}" name="category-${index}" value="sharrif" ${isCheckedSharrif} onchange="updateTransactionCategory(${index}, this.value)"> Sharrif
                    </label>
                    <label for="amrita-${index}">
                        <input type="radio" id="amrita-${index}" name="category-${index}" value="amrita" ${isCheckedAmrita} onchange="updateTransactionCategory(${index}, this.value)"> Amrita
                    </label>
                    <label for="shared-${index}">
                        <input type="radio" id="shared-${index}" name="category-${index}" value="shared" ${isCheckedShared} onchange="updateTransactionCategory(${index}, this.value)"> Shared
                    </label>
                </div>
            `;
            transactionList.appendChild(item);
        });
    }

    function updateTransactionCategory(index, category) {
        transactions[index].category = category;
        calculateInfoTotals();
    }

    function calculateInfoTotals() {
        let sharrifTotal = 0;
        let amritaTotal = 0;
        let sharedTotal = 0;

        transactions.forEach(t => {
            if (t.category === 'sharrif') {
                sharrifTotal += t.amount;
            } else if (t.category === 'amrita') {
                amritaTotal += t.amount;
            } else if (t.category === 'shared') {
                sharedTotal += t.amount;
            }
        });

        document.getElementById('sharrifTotalInfo').innerText = `Sharrif: $${sharrifTotal.toFixed(2)}`;
        document.getElementById('amritaTotalInfo').innerText = `Amrita: $${amritaTotal.toFixed(2)}`;
        document.getElementById('sharedTotalInfo').innerText = `Shared: $${sharedTotal.toFixed(2)}`;
        document.getElementById('infoSection').style.display = 'block';
    }

    function calculateTotals() {
        let sharrifTotal = 0;
        let amritaTotal = 0;
        let sharedTotal = 0;
        let allCategorized = true;

        transactions.forEach(t => {
            if (t.category === '') {
                allCategorized = false;
            } else if (t.category === 'sharrif') {
                sharrifTotal += t.amount;
            } else if (t.category === 'amrita') {
                amritaTotal += t.amount;
            } else if (t.category === 'shared') {
                sharedTotal += t.amount;
            }
        });

        if (!allCategorized) {
            alert("Please categorize all transactions before calculating final totals.");
            return;
        }

        const splitShared = sharedTotal / 2;
        sharrifTotal += splitShared;
        amritaTotal += splitShared;

        document.getElementById('sharrifTotal').innerText = `Sharrif's total: $${sharrifTotal.toFixed(2)}`;
        document.getElementById('amritaTotal').innerText = `Amrita's total: $${amritaTotal.toFixed(2)}`;
        document.getElementById('resultsSection').style.display = 'block';
    }

    function downloadCSV() {
        const headers = ['Date', 'Vendor', 'Amount', 'Category'];
        const csvRows = [headers.join(',')];

        transactions.forEach(t => {
            csvRows.push(`${t.date},"${t.vendor}",${t.amount.toFixed(2)},${t.category}`);
        });

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        
        const filename = document.getElementById('reportTitle').value.trim() || 'transaction_report';
        const filenameWithExt = filename.endsWith('.csv') ? filename : `${filename}.csv`;
        link.setAttribute("download", filenameWithExt);

        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function saveHtml() {
        let currentHtml = document.documentElement.outerHTML;
        const transactionsJson = JSON.stringify({ 
            transactions: transactions,
            title: document.getElementById('reportTitle').value
        }, null, 2);
        
        currentHtml = currentHtml.replace(
            /(<script id="saved-data-script" type="application\/json">)[\s\S]*?(<\/script>)/,
            `$1\n${transactionsJson}\n    $2`
        );

        const filename = document.getElementById('reportTitle').value.trim() || 'categorized_transactions';
        const filenameWithExt = filename.endsWith('.html') ? filename : `${filename}.html`;

        const blob = new Blob([currentHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = filenameWithExt;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>

</body>
</html>